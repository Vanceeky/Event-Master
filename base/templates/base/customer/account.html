{% extends 'base/layout.html' %}

{% block title %} Customer Account {% endblock %}

{% block stylesheet %}

{% endblock %}

{% block content %}


<section class="pt-3 pb-4" id="count-stats">
    
    <div class="p-3 shadow-blur">
      <div class="container">
        <div class="page-header min-height-300 border-radius-xl mt-4" style="
              background-image: url('/static/assets/img/curved-images/curved.jpg');
              background-position-y: 50%;
            "></div>
        <div class="card card-body blur mx-4 mt-n9 overflow-hidden">
          <form id="update-customer-form" class="row gx-4" method="POST" action="{% url 'update-customer-information' %}" enctype="multipart/form-data">
            <input type="hidden" value="{{ customer.user.id }}" name="customer_id">
            {% csrf_token %}
              <div class="col-md-3 z-index-1  ">
                <div class="section ">
                  <section class="z-index-1  text-center">
                    <div class="fileinput fileinput-new text-center" data-provides="fileinput">
                      <div id="profile-pic-container" class="mb-3">
                          <img id="profile-pic" src="{{ customer.avatar.url }}" alt="Profile Picture" class="img-fluid rounded-circle" style="width: 150px; height: 150px;">
                      </div>
                      <div class="mb-3">
                          <input type="file" id="file-input" name="avatar" class="d-none" accept="image/*">
                          <button id="change-profile-btn" type="button" class="btn btn-sm btn-secondary">Change Profile</button>
                      </div>
                    </div>
                      <h3 class="title mt-4 text-capitalize">{{ patient.user.first_name }} {{ patient.user.last_name }} </h3>
                  </section>
        
                </div>
              </div>
              <div class="col-md-8 ml-auto z-index-2">
                <div class="">
         
            
                    <p class="text-uppercase text-sm">User Information</p>
                    <div class="row">

                      <div class="col-md-6">
                        <div class="form-group">
                        <label for="example-text-input" class="form-control-label">Firstname</label>
                        <input class="form-control" type="text" name="firstname" value="{{ customer.user.first_name }}">
                        </div>
                      </div>

                      <div class="col-md-6">
                        <div class="form-group">
                        <label for="example-text-input" class="form-control-label">Lastname</label>
                        <input class="form-control" type="text" name="lastname" value="{{ customer.user.last_name }}">
                        </div>
                      </div>


                        <div class="col-md-6">
                            <div class="form-group">
                                <label for="example-text-input"  class="form-control-label">Email address</label>
                                <input class="form-control" type="email" name="email" value="{{ customer.user.email }}">
                            </div>
                        </div>

                    </div>

                    <hr class="horizontal dark">

                    <p class="text-uppercase text-sm">Contact Information</p>
                    <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                <label for="example-text-input" class="form-control-label">Contact Number</label>
                                <input class="form-control" type="text" name="contact_number" value="{{ customer.phone_number }}">
                                </div>
                            </div>
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="example-text-input" class="form-control-label">Address</label>
                                <input class="form-control" type="text" name="address" value="{{ customer.address }}">
                            </div>
                        </div>

                    </div>

                    <button type="submit" class="d-flex align-items-end btn btn-outline-info">Save Changes</button>

              

                </div>
             </div>




            <!-- ADD EVENT MODAL
            <div class="col-lg-4 text-end col-md-6 my-sm-auto ms-sm-auto me-sm-0 mx-auto mt-3">

                        <a type="button" data-bs-toggle="modal" data-bs-target="#create-event" class="btn btn-secondary btn-icon mb-3 mb-sm-0">
              <span class="btn-inner--icon"><i class="fa-solid fa-notes-medical"></i></span>
              <span class="btn-inner--text">Create New Event</span>
                      </a>

            </div>
            -->


            </form>
        </div>
      </div>
    </div>

    <div class="container">


      <div class="row mt-3">

        <!--
      <div class="col-12 col-xl-4 mt-md-0 mt-4">
          <div class="card h-100 d-flex">
             <div class="card-header pb-0 p-3">
                <div class="row">
                   <div class="col d-flex align-items-center">
                      <h6 class="mb-0">Edit Information</h6>
                   </div>
                   <div class="col text-end">
                      <a href="javascript:;">
                        <i class="fas fa-user-edit text-secondary text-sm" data-bs-toggle="tooltip" data-bs-placement="top" aria-hidden="true" aria-label="Edit Profile"></i> Save Changes
                      
                      </a>
                   </div>
                </div>
             </div>
             <div class="card-body p-3">
              <form>
                <div class="form-group">
                  <label for="exampleFormControlInput1">Firstname</label>
                  <input type="text" class="form-control" value="{{ customer.user.first_name }}" id="exampleFormControlInput1" placeholder="">
                </div>
                <div class="form-group">
                  <label for="exampleFormControlInput1">Lastname</label>
                  <input type="text" class="form-control" value="{{ customer.user.last_name}}" placeholder="">
                </div>
                <div class="form-group">
                  <label for="exampleFormControlInput1">Email address</label>
                  <input type="email" class="form-control" value="{{ customer.user.email }}" placeholder="name@example.com">
                </div>

                <div class="form-group">
                  <label for="exampleFormControlInput1">Phone Number</label>
                  <input type="number" class="form-control" value="{{ customer.phone_number }}" placeholder="name@example.com">
                </div>

                <div class="form-group">
                  <label for="exampleFormControlInput1">Address</label>
                  <input type="text" class="form-control" value="{{ customer.address }}" placeholder="name@example.com">
                </div>


              </form>

             </div>
          </div>
      </div>
      -->


        <!--
        <div class="col-xl-3 mt-md-0 mt-4">
          <div class="card h-auto">
            <div class="card-header pb-0 p-3">
              <div class="row">
                <div class="col-md-8 d-flex align-items-center">
                  <h6 class="mb-0">Profile Information</h6>
                </div>
                <div class="col-md-4 text-end">
                  <a href="javascript:;">
                    <i class="fas fa-user-edit text-secondary text-sm" data-bs-toggle="tooltip" data-bs-placement="top"
                      aria-hidden="true" aria-label="Edit Profile" data-bs-original-title="Edit Profile"></i><span
                      class="sr-only">Edit Profile</span>
                  </a>
                </div>
              </div>
            </div>
            <div class="card-body p-3">
              <ul class="list-group">
                <li class="list-group-item border-0 ps-0 text-sm">
                  <strong class="text-dark"><i class="fa fa-phone"></i></strong> &nbsp; {{ customer.phone_number }}
                </li>
                <li class="list-group-item border-0 ps-0 text-sm">
                  <strong class="text-dark"><i class="fa fa-envelope"></i></strong> &nbsp; {{ customer.user.email }}
                </li>
                <li class="list-group-item border-0 ps-0 text-sm">
                  <strong class="text-dark"><i class="fa fa-map-marker"></i></strong> &nbsp; {{ customer.address }}
                </li>
                <li class="list-group-item border-0 ps-0 pb-0">
                  <strong class="text-dark text-sm">Social:</strong> &nbsp;
                  <a class="btn btn-facebook btn-simple mb-0 ps-1 pe-2 py-0" href="javascript:;">
                    <i class="fab fa-facebook fa-lg" aria-hidden="true"></i>
                  </a>
                  <a class="btn btn-twitter btn-simple mb-0 ps-1 pe-2 py-0" href="javascript:;">
                    <i class="fab fa-twitter fa-lg" aria-hidden="true"></i>
                  </a>
                  <a class="btn btn-instagram btn-simple mb-0 ps-1 pe-2 py-0" href="javascript:;">
                    <i class="fab fa-instagram fa-lg" aria-hidden="true"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
        -->

 

        <!--
        <div class="col mt-xl-0 mt-4">
         

          {% for event in events %}
              <div class="card mb-3 mt-lg-0 mt-4" id="event_{{ event.id }}">
                <div class="row">
                  <div class="col-md-4">
                    <div class="card-body h-auto pb-0">
                      
                      <div class="row align-items-center mb-3">
                        <div class="col-9">
                          <h5 class="mb-0">
                            <a href="javascript:;">{{ event.title }}</a>
                          </h5>
                          <span class="text-sm ms-auto mt-0">{{ event.event_date }}</span>
                        </div>
                        <div class="col-3 text-end">
                          <div class="dropstart">
                            <a href="javascript:;" class="text-secondary" id="dropdownMarketingCard" data-bs-toggle="dropdown" aria-expanded="false">
                              <i class="fas fa-ellipsis-v" aria-hidden="true"></i>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-lg-start px-2 py-3" aria-labelledby="dropdownMarketingCard">
                              <li><a class="dropdown-item border-radius-md" href="javascript:;">Edit Team</a></li>
                              <li><a class="dropdown-item border-radius-md" href="javascript:;">Add Member</a></li>
                              <li><a class="dropdown-item border-radius-md" href="javascript:;">See Details</a></li>
                              <li><hr class="dropdown-divider"></li>
                              <li><a class="dropdown-item border-radius-md text-danger" href="javascript:;">Remove Team</a></li>
                            </ul>
                          </div>
                        </div>
                      </div>

                      
                      <ul class="list-unstyled mx-auto">
                        <li class="d-flex">
                          <p class="mb-0">Venue:</p>
                          <span class="ms-auto">{{ event.location }}</span>
                        </li>
            
                        <li>
                          <hr class="horizontal dark">
                        </li>
            
                        <li class="d-flex">
                          <p class="mb-0">Budget:</p>
                          <span class="ms-auto" id="budget_{{ event.id }}">₱ {{ event.budget }}</span>
                        </li>
            
                        <li>
                          <hr class="horizontal dark">
                        </li>
            
                        <li class="d-flex">
                          <p class="mb-0">Estimated Bill:</p>
                          <span class="ms-auto" id="estimated_bill_{{ event.id }}">₱ 0.00</span>
                        </li>
            
                        <li id="budget_note_{{ event.id }}" class="mt-4 d-none">
                          <p class="text-danger">Note: The estimated bill exceeds the budget.</p>
                        </li>
                      </ul>
                    </div>
                  </div>
            
                  <div class="col-md-8">
                    <div class="card-body pb-0">
                      <div class="card mb-2">
                        {% for selected_service in event.selected_services.all %}
                          <div class="mb-2 text-white bg-gradient-secondary pt-2 p-3">
                            <div class="d-flex align-items-center justify-content-between">
                              <div class="d-flex">
                                <div class="avatar avatar-lg">
                                  <img alt="Image placeholder" src="{{ selected_service.service.provider.logo.url }}">
                                </div>
                                <div class="ms-2 my-auto">
                                  <h6 class="mb-0"><a href="{% url 'service-details' selected_service.service.id %}" type="button" class="text-white card-title h5 mb-0 d-block" data-bs-toggle="tooltip" data-bs-placement="left" title="View Service">
                                    {{ selected_service.service.name }}
                                  </a></h6>
                                  <p class="text-xs text-white mb-0"><a class="text-white" href="{% url 'service-provider' selected_service.service.provider.id %}">{{ selected_service.service.provider }}</a></p>
                                </div>
                              </div>
                              <a href="" type="button" class="service-price text-white card-title h5 mb-0 d-block">
                                ₱ {{ selected_service.service.price }}
                              </a>
                            </div>
            
                            <p class="card-description">
                              <ul>
                                <strong class="mb-0">Inclusions</strong>
                                {% if selected_service.service.inclusions_list %}
                                  {% for inclusion in selected_service.service.inclusions_list %}
                                    <li class="text-sm">{{ inclusion }}</li>
                                  {% endfor %}
                                {% else %}
                                  <strong>No inclusions listed.</strong>
                                {% endif %}
                              </ul>
                            </p>
            
                            <div class="d-flex justify-content-between align-items-center">
                              <span class="badge bg-gradient-warning">{{ selected_service.status }}</span>
                              <div class="dropstart">
                                <a href="{% url 'remove_service_from_event' selected_service.id %}" class="text-white" aria-expanded="false" data-bs-toggle="tooltip" data-bs-placement="top" title="Remove Service">
                                  <i class="fas fa-trash" aria-hidden="true"></i>
                                </a>
                              </div>
                            </div>
                          </div>
                        {% empty %}
                          <li>No services associated with this event.</li>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
          {% empty %}
            <li>No events found.</li>
          {% endfor %}

        </div>
        -->
   
      
      </div>
    </div>

   
</section>



  <!--- MODALS -->



{% endblock %}


{% block js %}


<script>
  $('#update-customer-form').on('submit', function(e) {
    e.preventDefault(); // Prevent the default form submission
    var form = $(this);
    var formData = new FormData(this); // Create FormData object to include file input

    $.ajax({
        type: form.attr('method'),
        url: form.attr('action'),
        data: formData,
        contentType: false, // Important for file uploads
        processData: false, // Important for file uploads
        success: function(response) {
            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: response.message,
                showConfirmButton: true,

            }).then(function() {
                location.reload();  // Reload the page after success
            });
        },
        error: function(xhr) {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'Something went wrong! ' + xhr.responseJSON.message,
            });
        }
    });
});

</script>

<script>
  document.getElementById('change-profile-btn').addEventListener('click', function() {
    document.getElementById('file-input').click(); // Trigger the file input click
});

// Preview the selected image
document.getElementById('file-input').addEventListener('change', function(event) {
    const file = event.target.files[0]; // Get the selected file
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('profile-pic').src = e.target.result; // Show the preview
        };
        reader.readAsDataURL(file); // Read the file as data URL
    }
});


</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    function calculateEstimatedBill() {
      // Select all event cards
      const eventCards = document.querySelectorAll('.card');
      console.log('Event Cards:', eventCards); // Debug: Check selected event cards
      
      // Loop through each event card to calculate estimated bills
      eventCards.forEach(card => {
        const eventId = card.id.split('_')[1]; // Extract event ID from card ID
        console.log('Processing Event ID:', eventId); // Debug: Check the extracted event ID
        
        // Select all price elements for this event
        const prices = card.querySelectorAll('.service-price');
        console.log('Prices for Event:', prices); // Debug: Check selected prices
        
        let total = 0;

        // Calculate the total estimated bill for this event
        prices.forEach(priceElement => {
          const priceText = priceElement.textContent.trim().replace('₱', '').replace(',', '');
          const price = parseFloat(priceText);
          if (!isNaN(price)) {
            total += price;
          }
        });

        console.log('Total Estimated Bill for Event:', total); // Debug: Check the calculated total
        
        // Update the estimated bill element for this event
        const estimatedBillElement = card.querySelector(`#estimated_bill_${eventId}`);
        if (estimatedBillElement) {
          estimatedBillElement.textContent = '₱ ' + total.toFixed(2);
          console.log('Updated Estimated Bill Element:', estimatedBillElement); // Debug: Check the updated element
        }

        // Extract and compare the budget
        const budgetElement = card.querySelector(`#budget_${eventId}`);
        const budgetNoteElement = card.querySelector(`#budget_note_${eventId}`);

        if (budgetElement && estimatedBillElement && budgetNoteElement) {
          const budgetText = budgetElement.textContent.trim().replace('₱', '').replace(',', '');
          const budget = parseFloat(budgetText);
          
          console.log('Budget for Event:', budget); // Debug: Check the extracted budget

          if (budget && total > budget) {
            budgetNoteElement.classList.remove('d-none');
            console.log('Budget Note: The estimated bill exceeds the budget.'); // Debug: Check if the note is shown
          } else {
            budgetNoteElement.classList.add('d-none');
            console.log('Budget Note: The estimated bill is within the budget.'); // Debug: Check if the note is hidden
          }
        }
      });
    }
    
    calculateEstimatedBill();
  });
</script>





{% endblock %}